We consider a microgrid with random load realization, stochastic renewable energy production, and an energy storage unit. The grid controller provides the total net load trajectory that the microgrid should present to the main grid and the microgrid must impose load shedding and renewable energy curtailment if necessary to meet that net load trajectory. The microgrid controller seeks to operate the local energy storage unit to minimize the risk of load shedding, and renewable energy curtailment over a finite time horizon. We formulate the problem of optimizing the operation of the storage unit as a finite stage dynamic programming problem. We prove that the multi-stage objective function of the energy storage is strictly convex in the state of charge of the battery at each stage. The uniqueness of the optimal decision is proven under some additional assumptions. The optimal strategy is then obtained. The effectiveness of the energy storage in decreasing load shedding and RE curtailment is illustrated in simulations.