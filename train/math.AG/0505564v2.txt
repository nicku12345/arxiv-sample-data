The goal of this paper is to generalize a theorem of Fujiwara (formerly Deligne's conjecture) to the situation appearing in a joint work [KV] with David Kazhdan on the global Langlands correspondence over function fields. Moreover, our proof is more elementary than the original one and stays in the realm of ordinary algebraic geometry, that is, does not use rigid geometry. We also include proof of the Lefschetz-Verdier trace formula and of the additivity of filtered trace maps, thus making the paper essentially self-contained.