The paper suggests a new stochastic model for energy producing, dispatching, and storing in the multi-battery setting that takes into account the topology of the system of the links between the batteries, the transmission and storage losses, and requirements for special regimes for batteries charging and discharging helping to prolong batteries life. For this model, the problem of optimal energy storing and dispatching is considered and solved using dynamic programming and duality methods.