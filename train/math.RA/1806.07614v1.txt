We investigate a semigroup construction related to the two-sided wreath product. It encompasses a range of known constructions and gives a slightly finer version of the decomposition in the Krohn-Rhodes Theorem, in which the three-element flip-flop is replaced by the two-element semilattice. We develop foundations of the theory of our construction, showing in the process that it naturally combines ideas from semigroup theory (wreath products), category theory (Grothendieck construction), and ordered structures (residuated lattices).